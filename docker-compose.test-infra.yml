# =============================================================================
# Test Infrastructure for Catalogizer Integration Tests
# =============================================================================
#
# Provides FTP, SMB, WebDAV, and NFS servers with shared test data for
# running integration tests against real protocol implementations.
#
# Usage:
#   podman-compose -f docker-compose.test-infra.yml up -d
#   podman-compose -f docker-compose.test-infra.yml down
#
# Resource budget: max 2 CPUs, 2 GB RAM total (0.5 CPU / 512 MB each)
#
# Test data volume:
#   All services share a common test-data volume mounted at /test-data/.
#   Seed it by placing files in ./tests/test-data/ on the host.
#
# Environment variables for integration tests (set automatically):
#   FTP_TEST_SERVER=localhost:2121
#   SMB_TEST_SERVER=localhost:1445
#   WEBDAV_TEST_SERVER=localhost:8081
#   NFS_TEST_SERVER=localhost:2049
#
# NOTE: Ports remapped for rootless Podman (no privileged ports < 1024):
#   FTP: 21 -> 2121, passive: 30000-30009 (unchanged)
#   SMB: 445 -> 1445, 139 -> 1139
#   NFS: 111 -> 1111, 2049 (unchanged, already > 1024)
# =============================================================================

version: '3.8'

services:

  # ---------------------------------------------------------------------------
  # FTP Server (Pure-FTPd)
  # ---------------------------------------------------------------------------
  # Lightweight FTP server with anonymous access enabled for testing.
  # Anonymous users can read from /test-data/ (mapped to FTP root).
  # Pure-FTPd is chosen over vsftpd for simpler container configuration.
  ftp:
    image: docker.io/stilliard/pure-ftpd:latest
    container_name: catalogizer-test-ftp
    environment:
      # Enable anonymous login for integration tests
      FTP_USER_NAME: testuser
      FTP_USER_PASS: testpass
      FTP_USER_HOME: /home/ftpusers/testuser
      PUBLICHOST: "localhost"
      # Passive port range for data connections
      FTP_PASSIVE_PORTS: "30000:30009"
      FTP_MAX_CLIENTS: "10"
      FTP_MAX_CONNECTIONS: "5"
    ports:
      - "2121:21"
      - "30000-30009:30000-30009"
    volumes:
      # Mount shared test data into the FTP user's home directory
      # NOTE: rw required because pure-ftpd needs to chown the home directory
      - test_data:/home/ftpusers/testuser
      # Persistent FTP configuration
      - ftp_config:/etc/pure-ftpd
    healthcheck:
      test: ["CMD-SHELL", "nc -z localhost 21 || exit 1"]  # internal port is still 21
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    restart: unless-stopped
    networks:
      - test-network
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.1'
          memory: 64M

  # ---------------------------------------------------------------------------
  # SMB Server (Samba)
  # ---------------------------------------------------------------------------
  # Samba server with a public guest share for testing SMB protocol access.
  # The 'testshare' share is accessible without authentication (guest ok).
  # Maps /test-data/ as a read-only share for scanning tests.
  smb:
    image: docker.io/dperson/samba:latest
    container_name: catalogizer-test-smb
    command: >
      -s "testshare;/test-data;yes;no;yes;all;none;;Test Share for Integration Tests"
      -u "testuser;testpass"
      -p
      -n
      -g "map to guest = Bad User"
      -g "server min protocol = SMB2"
    ports:
      - "1445:445"
      - "1139:139"
    volumes:
      # Mount shared test data as the SMB share root
      - test_data:/test-data:ro
    healthcheck:
      test: ["CMD-SHELL", "smbclient -L localhost -N 2>/dev/null | grep -q testshare || exit 1"]
      interval: 15s
      timeout: 10s
      retries: 5
      start_period: 15s
    restart: unless-stopped
    networks:
      - test-network
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.1'
          memory: 64M

  # ---------------------------------------------------------------------------
  # WebDAV Server (nginx with DAV module)
  # ---------------------------------------------------------------------------
  # Nginx configured with the WebDAV module for testing WebDAV protocol.
  # Serves /test-data/ as a WebDAV-accessible directory on port 8081.
  # No authentication required for test simplicity.
  webdav:
    image: docker.io/bytemark/webdav:latest
    container_name: catalogizer-test-webdav
    environment:
      # Bytemark webdav image supports these env vars for configuration
      AUTH_TYPE: Basic
      USERNAME: testuser
      PASSWORD: testpass
    ports:
      - "8081:80"
    volumes:
      # Mount shared test data as the WebDAV root
      # NOTE: rw required because webdav image runs chown on startup
      - test_data:/var/lib/dav/data
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost:80/ -o /dev/null || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    restart: unless-stopped
    networks:
      - test-network
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.1'
          memory: 64M

  # ---------------------------------------------------------------------------
  # NFS Server (nfs-ganesha via erichough/nfs-server)
  # ---------------------------------------------------------------------------
  # NFS server exporting /test-data/ for testing NFS protocol access.
  # Uses host networking because NFS requires specific kernel modules and
  # port mappings that do not work well with bridged networking.
  #
  # IMPORTANT: NFS requires privileged mode and kernel NFS support on the host.
  # On some systems you may need to: modprobe nfs nfsd
  nfs:
    image: docker.io/erichough/nfs-server:latest
    container_name: catalogizer-test-nfs
    environment:
      # Export /test-data as read-only to all clients
      NFS_EXPORT_0: "/test-data *(ro,fsid=0,no_subtree_check,no_auth_nlm,insecure,no_root_squash)"
      NFS_LOG_LEVEL: "DEBUG"
    ports:
      - "2049:2049"
      - "2049:2049/udp"
      - "1111:111"
      - "1111:111/udp"
    volumes:
      # Mount shared test data as the NFS export
      - test_data:/test-data:ro
    cap_add:
      - SYS_ADMIN
    # NFS server requires privileged mode for kernel module access
    privileged: true
    healthcheck:
      test: ["CMD-SHELL", "rpcinfo -p localhost 2>/dev/null | grep -q nfs || exit 1"]
      interval: 15s
      timeout: 10s
      retries: 5
      start_period: 20s
    restart: unless-stopped
    networks:
      - test-network
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.1'
          memory: 128M

  # ---------------------------------------------------------------------------
  # Test Data Seeder (init container)
  # ---------------------------------------------------------------------------
  # One-shot container that populates the shared test-data volume with
  # sample files for protocol testing. Runs once and exits.
  test-data-seeder:
    image: docker.io/library/alpine:3.19
    container_name: catalogizer-test-data-seeder
    volumes:
      - test_data:/test-data
    entrypoint: ["/bin/sh", "-c"]
    command:
      - |
        echo "Seeding test data volume..."
        mkdir -p /test-data/movies /test-data/music /test-data/series /test-data/software
        # Create sample media files (empty files with realistic names)
        echo "Sample movie file" > "/test-data/movies/The.Matrix.1999.1080p.BluRay.mkv"
        echo "Sample movie file" > "/test-data/movies/Inception.2010.720p.BluRay.mp4"
        echo "Sample movie file" > "/test-data/movies/Interstellar.2014.2160p.UHD.mkv"
        # Music files
        echo "Sample music file" > "/test-data/music/Artist - Song Title.mp3"
        echo "Sample music file" > "/test-data/music/Another Artist - Track Name.flac"
        mkdir -p "/test-data/music/Pink Floyd/The Dark Side of the Moon"
        echo "Sample music file" > "/test-data/music/Pink Floyd/The Dark Side of the Moon/01 - Speak to Me.flac"
        echo "Sample music file" > "/test-data/music/Pink Floyd/The Dark Side of the Moon/02 - Breathe.flac"
        # TV series
        mkdir -p "/test-data/series/Breaking Bad/Season 01"
        echo "Sample episode" > "/test-data/series/Breaking Bad/Season 01/Breaking.Bad.S01E01.Pilot.mkv"
        echo "Sample episode" > "/test-data/series/Breaking Bad/Season 01/Breaking.Bad.S01E02.mkv"
        mkdir -p "/test-data/series/Breaking Bad/Season 02"
        echo "Sample episode" > "/test-data/series/Breaking Bad/Season 02/Breaking.Bad.S02E01.mkv"
        # Software
        echo "Sample software" > "/test-data/software/app-installer-v1.0.exe"
        echo "Sample software" > "/test-data/software/tool-setup-2.3.1.dmg"
        # Nested directories for depth testing
        mkdir -p /test-data/deep/level1/level2/level3/level4
        echo "Deep file" > /test-data/deep/level1/level2/level3/level4/deep_file.txt
        echo "Test data seeded successfully."
    restart: "no"
    deploy:
      resources:
        limits:
          cpus: '0.1'
          memory: 64M

volumes:
  # Shared test data volume â€” all protocol servers mount this read-only.
  # Seeded by the test-data-seeder init container.
  test_data:
    driver: local
  # Pure-FTPd persistent configuration
  ftp_config:
    driver: local

networks:
  test-network:
    driver: bridge
