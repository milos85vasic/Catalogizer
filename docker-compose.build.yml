# Containerized Build, Test & Release Pipeline for Catalogizer
# Usage: podman-compose -f docker-compose.build.yml up --build --abort-on-container-exit
# Or via: ./scripts/container-build.sh [version]

services:
  # ============================================================
  # PostgreSQL 15 - Integration test database
  # ============================================================
  postgres:
    image: docker.io/library/postgres:15-alpine
    environment:
      POSTGRES_DB: catalogizer_test
      POSTGRES_USER: catalogizer
      POSTGRES_PASSWORD: catalogizer_test_pass
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U catalogizer -d catalogizer_test"]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 10s
    ports:
      - "5432:5432"
    tmpfs:
      - /var/lib/postgresql/data

  # ============================================================
  # Redis 7 - Integration test cache
  # ============================================================
  redis:
    image: docker.io/library/redis:7-alpine
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 5s
    ports:
      - "6379:6379"
    tmpfs:
      - /data

  # ============================================================
  # Main builder container
  # Multi-toolchain: Go + Node + Rust + JDK + Android SDK
  # Uses host networking for reliable package downloads
  # ============================================================
  catalogizer-builder:
    image: localhost/catalogizer-builder:latest
    build:
      context: .
      dockerfile: docker/Dockerfile.builder
      network: host
    network_mode: host
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    environment:
      # Infrastructure (use localhost since builder uses host network)
      POSTGRES_HOST: 127.0.0.1
      POSTGRES_PORT: 5432
      POSTGRES_DB: catalogizer_test
      POSTGRES_USER: catalogizer
      POSTGRES_PASSWORD: catalogizer_test_pass
      REDIS_HOST: 127.0.0.1
      REDIS_PORT: 6379
      # Build configuration
      BUILD_VERSION: "${BUILD_VERSION:-1.0.0}"
      BUILD_NUMBER: "${BUILD_NUMBER:-0}"
      BUILD_COMPONENTS_ENV: "${BUILD_COMPONENTS:-all}"
      FORCE_BUILD: "${FORCE_BUILD:-false}"
      SKIP_TESTS: "${SKIP_TESTS:-false}"
      SKIP_EMULATOR_TESTS: "${SKIP_EMULATOR_TESTS:-true}"
      SKIP_E2E_TESTS: "${SKIP_E2E_TESTS:-false}"
      SKIP_SECURITY_TESTS: "${SKIP_SECURITY_TESTS:-true}"
      # Database config for Go tests
      DB_TYPE: postgres
      DB_HOST: 127.0.0.1
      DB_PORT: 5432
      DB_NAME: catalogizer_test
      DB_USER: catalogizer
      DB_PASSWORD: catalogizer_test_pass
      # CI mode
      CI: "true"
      # Go toolchain - use local, don't try to download newer versions
      GOTOOLCHAIN: local
      # Android SDK
      ANDROID_HOME: /opt/android-sdk
      ANDROID_SDK_ROOT: /opt/android-sdk
    volumes:
      - .:/project
      - go-cache:/root/go
      - gradle-cache:/root/.gradle
      - npm-cache:/root/.npm
      - cargo-cache:/root/.cargo/registry

  # ============================================================
  # Android Emulator (optional, requires KVM on host)
  # Activate with: --profile emulator
  # ============================================================
  android-emulator:
    image: docker.io/budtmo/docker-android:emulator_14.0
    profiles:
      - emulator
    privileged: true
    environment:
      EMULATOR_DEVICE: "pixel_5"
      WEB_VNC: "true"
    ports:
      - "6080:6080"   # VNC web viewer
      - "5555:5555"   # ADB
    devices:
      - /dev/kvm

volumes:
  go-cache:
  gradle-cache:
  npm-cache:
  cargo-cache:
